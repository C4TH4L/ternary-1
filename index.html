    <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ternary Plot Survey with Hover Labels</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  h1 { text-align: center; margin-bottom: 30px; }
  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .card { border: 1px solid #ccc; border-radius: 10px; padding: 10px; }
  .plot-title { font-weight: bold; text-align: center; margin-bottom: 10px; }
  svg { width: 100%; height: 500px; cursor: crosshair; }
  .hover-label { font-size: 12px; font-weight: bold; pointer-events: none; background-color: rgba(255,255,255,0.8); }
</style>
</head>
<body>

<h1>Ternary Plot Survey</h1>

<div class="grid">
  <div class="card">
    <div class="plot-title">Where do you think peoples values currently lie</div>
    <svg id="plot-today"></svg>
  </div>
  <div class="card">
    <div class="plot-title">Where do you think peoples values in 2075 will lie</div>
    <svg id="plot-2075"></svg>
  </div>
</div>

<script>
// ---- Configuration ----
const plots = [
  {id:'plot-today', storage:'responseToday'},
  {id:'plot-2075', storage:'responseFuture'}
];
const margin = {top:40,right:40,bottom:40,left:40};

// ---- Helper Functions ----
function barycentricCoordinates(px, py, A, B, C){
    const det = (B[1]-C[1])*(A[0]-C[0]) + (C[0]-B[0])*(A[1]-C[1]);
    let alpha = ((B[1]-C[1])*(px-C[0]) + (C[0]-B[0])*(py-C[1])) / det;
    let beta  = ((C[1]-A[1])*(px-C[0]) + (A[0]-C[0])*(py-C[1])) / det;
    let gamma = 1 - alpha - beta;
    alpha = Math.max(0, alpha); beta = Math.max(0, beta); gamma = Math.max(0, gamma);
    const sum = alpha+beta+gamma;
    return [alpha/sum*100, beta/sum*100, gamma/sum*100];
}

function sendResponse(plotId, response){
    const url = 'https://script.google.com/macros/s/AKfycbyfO5x1rNsoEje-99SjESORkz6MHcICfimjBr80QSXqc1_OkBEILihhVb-Dn5_zqhLp/exec'; // <-- replace with your Apps Script URL
    fetch(url, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({plot: plotId, response: response})
    }).then(r=>r.text()).then(t=>console.log('Response sent', t))
    .catch(err=>console.error(err));
}

// ---- Draw a single ternary plot ----
function drawPlot(plotId, storageKey){
    const svg = d3.select(`#${plotId}`);
    const width = svg.node().clientWidth - margin.left - margin.right;
    const height = svg.node().clientHeight - margin.top - margin.bottom;

    const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

    // Equilateral triangle vertices
    const A = [0, height];
    const B = [width, height];
    const C = [width/2, 0];

    // Draw triangle
    g.append("polygon")
      .attr("points", [A,B,C].map(d=>d.join(',')).join(' '))
      .attr("fill","none")
      .attr("stroke","#333")
      .attr("stroke-width",2);

    // Axis labels
    g.append("text").text("Social").attr("x",A[0]-10).attr("y",A[1]+15).attr("text-anchor","end");
    g.append("text").text("Physical").attr("x",B[0]+10).attr("y",B[1]+15).attr("text-anchor","start");
    g.append("text").text("Environmental").attr("x",C[0]).attr("y",C[1]-10).attr("text-anchor","middle");

    // Hover & response circles
    const hoverCircle = g.append("circle").attr("r",7).attr("fill","blue").attr("opacity",0.6).style("pointer-events","none");
    const hoverLabel = g.append("text").attr("class","hover-label").attr("x",0).attr("y",0).attr("opacity",0);
    let responseCircle = null;

    const stored = JSON.parse(localStorage.getItem(storageKey)||'null');
    if(stored){
        responseCircle = g.append("circle")
                          .attr("r",7).attr("fill","red")
                          .attr("cx",A[0]*stored[0]/100 + B[0]*stored[1]/100 + C[0]*stored[2]/100)
                          .attr("cy",A[1]*stored[0]/100 + B[1]*stored[1]/100 + C[1]*stored[2]/100);
    }

    let submitted = !!stored;

    svg.on("mousemove", function(event){
        if(submitted) return;
        const [mx,my] = d3.pointer(event);
        const coords = barycentricCoordinates(mx-margin.left, my-margin.top, A,B,C);
        const cx = A[0]*coords[0]/100 + B[0]*coords[1]/100 + C[0]*coords[2]/100;
        const cy = A[1]*coords[0]/100 + B[1]*coords[1]/100 + C[1]*coords[2]/100;
        hoverCircle.attr("cx",cx).attr("cy",cy).attr("opacity",0.6);
        hoverLabel.attr("x",cx+10).attr("y",cy-10)
                  .text(`S:${coords[0].toFixed(1)} P:${coords[1].toFixed(1)} E:${coords[2].toFixed(1)}`)
                  .attr("opacity",1);
    });

    svg.on("mouseleave", function(){ hoverCircle.attr("opacity",0); hoverLabel.attr("opacity",0); });

    svg.on("click", function(event){
        if(submitted) return;
        const [mx,my] = d3.pointer(event);
        const coords = barycentricCoordinates(mx-margin.left, my-margin.top, A,B,C);
        const cx = A[0]*coords[0]/100 + B[0]*coords[1]/100 + C[0]*coords[2]/100;
        const cy = A[1]*coords[0]/100 + B[1]*coords[1]/100 + C[1]*coords[2]/100;

        responseCircle = g.append("circle").attr("r",7).attr("fill","red").attr("cx",cx).attr("cy",cy);
        localStorage.setItem(storageKey, JSON.stringify(coords));
        sendResponse(plotId, coords);
        alert(`Recorded:\nSocial: ${coords[0].toFixed(1)}%\nPhysical: ${coords[1].toFixed(1)}%\nEnvironmental: ${coords[2].toFixed(1)}%`);
        submitted = true;
        hoverCircle.attr("opacity",0); hoverLabel.attr("opacity",0);
    });
}

// ---- Initialize both plots ----
plots.forEach(p => drawPlot(p.id, p.storage));
</script>

</body>
</html>

   













