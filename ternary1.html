<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ternary Plot Survey</title>
<script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  h1 { text-align: center; margin-bottom: 30px; }
  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .card { padding: 10px; border: 1px solid #ccc; border-radius: 10px; }
  .plot-title { font-weight: bold; text-align: center; margin-bottom: 10px; }
  .plot-wrap { height: 500px; }
</style>
</head>
<body>
<h1>Ternary Plot Survey</h1>

<div class="grid">
  <div class="card">
    <div class="plot-title">Where do you think peoples values currently lie</div>
    <div id="plot-today" class="plot-wrap"></div>
  </div>
  <div class="card">
    <div class="plot-title">Where do you think peoples values in 2075 will lie</div>
    <div id="plot-2075" class="plot-wrap"></div>
  </div>
</div>

<script>
// ---- Helper to create a point trace ----
function makeTrace(points, name, color='red'){
  return {
    type:'scatterternary',
    a: points.map(p=>p[0]),
    b: points.map(p=>p[1]),
    c: points.map(p=>p[2]),
    mode:'markers',
    marker:{size:10,color:color},
    name: name
  };
}

// ---- Layout ----
const layout = {
  ternary:{sum:100, aaxis:{title:'Social'}, baxis:{title:'Physical'}, caxis:{title:'Environmental'}},
  margin:{l:40,r:40,t:40,b:40}
};

// ---- Send response to Google Sheets ----
function sendResponse(plotId, response) {
  const url = 'https://script.google.com/macros/s/AKfycbwQKs6qYO_OD-rMhZZljH-C2hXnn5eAf9Bku7B2sjR5vkJKJCF_E6jjDFFgbv8GDzuo/exec'; // <-- Replace with your Google Apps Script Web App URL
  const data = { plot: plotId, response: response };
  fetch(url, {
    method: 'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify(data)
  })
  .then(res => res.text())
  .then(res => console.log('Response recorded:', res))
  .catch(err => console.error('Error sending response:', err));
}

// ---- Convert click position to ternary coordinates ----
function getTernaryFromClick(event, plotId) {
  const plot = document.getElementById(plotId);
  const rect = plot.getBoundingClientRect();

  // Mouse position in plot area
  const x = event.clientX - rect.left;
  const y = event.clientY - rect.top;
  const w = rect.width;
  const h = rect.height;

  // normalize to [0,1]
  const nx = x / w;
  const ny = 1 - (y / h);

  // simple barycentric approx
  let a = nx;
  let b = ny;
  let c = 1 - (a + b);

  if (c < 0) c = 0;
  if (a < 0) a = 0;
  if (b < 0) b = 0;

  const sum = a+b+c;
  return [ (a/sum)*100, (b/sum)*100, (c/sum)*100 ];
}

// ---- Render a blank plot, allow one response ----
function renderPlot(plotId, storageKey){
  const traces = []; // start empty
  const userPoint = JSON.parse(localStorage.getItem(storageKey) || 'null');
  if (userPoint) traces.push(makeTrace([userPoint],'Your Response','red'));
  Plotly.newPlot(plotId, traces, layout);

  let submitted = !!userPoint;
  const plotEl = document.getElementById(plotId);

  plotEl.addEventListener('click', function(ev){
    if (submitted) return;
    const point = getTernaryFromClick(ev, plotId);
    Plotly.addTraces(plotId, makeTrace([point],'Your Response','red'));
    localStorage.setItem(storageKey, JSON.stringify(point));
    sendResponse(plotId, point);
    alert(`Your response has been recorded!\n\nSocial: ${point[0].toFixed(1)}%\nPhysical: ${point[1].toFixed(1)}%\nEnvironmental: ${point[2].toFixed(1)}%`);
    submitted = true;
  });
}

// ---- Render both plots ----
renderPlot('plot-today', 'responseToday');
renderPlot('plot-2075', 'responseFuture');
</script>
</body>
</html>

